name: observability-stack

services:
  prometheus:
    image: prom/prometheus:v2.51.0
    ports:
      - '${PROMETHEUS_PORT:-9090}:9090'
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    environment:
      PROMETHEUS_SCRAPE_TARGET: ${PROMETHEUS_SCRAPE_TARGET:-host.docker.internal:3001}
      PROMETHEUS_JOB_NAME: ${PROMETHEUS_JOB_NAME:-application-api}
      PROMETHEUS_RETENTION: ${PROMETHEUS_RETENTION:-15d}
    volumes:
      - ./prometheus/prometheus.yml.tmpl:/etc/prometheus/prometheus.yml.tmpl:ro
      - ./prometheus/alert-rules.yml:/etc/prometheus/alert-rules.yml:ro
      - prometheus-data:/prometheus
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        sed "s|__PROMETHEUS_SCRAPE_TARGET__|$${PROMETHEUS_SCRAPE_TARGET}|g; s|__PROMETHEUS_JOB_NAME__|$${PROMETHEUS_JOB_NAME}|g" \
          /etc/prometheus/prometheus.yml.tmpl > /tmp/prometheus.yml
        exec /bin/prometheus \
          --config.file=/tmp/prometheus.yml \
          --storage.tsdb.retention.time=$${PROMETHEUS_RETENTION}

  grafana:
    image: grafana/grafana:11.0.0
    ports:
      - '${GRAFANA_PORT:-3003}:3000'
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      GF_AUTH_ANONYMOUS_ENABLED: 'true'
      GF_AUTH_ANONYMOUS_ORG_ROLE: Viewer
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana-data:/var/lib/grafana
    depends_on:
      - prometheus
      - loki
      - jaeger

  loki:
    image: grafana/loki:3.0.0
    ports:
      - '${LOKI_PORT:-3100}:3100'
    volumes:
      - ./loki/loki-config.yml:/etc/loki/config.yaml:ro
      - loki-data:/loki
    entrypoint: ["/bin/sh", "-c"]
    environment:
      LOKI_RETENTION: ${LOKI_RETENTION:-168h}
    command:
      - |
        sed "s|__LOKI_RETENTION__|$${LOKI_RETENTION}|g" /etc/loki/config.yaml > /tmp/loki-config.yaml
        exec /usr/bin/loki -config.file=/tmp/loki-config.yaml

  jaeger:
    image: jaegertracing/all-in-one:1.56
    user: '0:0'
    ports:
      - '${JAEGER_UI_PORT:-16686}:16686'
      - '${JAEGER_OTLP_HTTP_PORT:-4318}:4318'
    environment:
      COLLECTOR_OTLP_ENABLED: 'true'
      SPAN_STORAGE_TYPE: badger
      BADGER_EPHEMERAL: 'false'
      BADGER_DIRECTORY_VALUE: /badger/data
      BADGER_DIRECTORY_KEY: /badger/key
    volumes:
      - jaeger-data:/badger

volumes:
  prometheus-data:
  grafana-data:
  loki-data:
  jaeger-data:
